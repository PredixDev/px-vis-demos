<!doctype html>

<html>
  <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>Crosshair example</title>
      <!-- Requires Webcomponents.js polyfill is provided by the page for browsers that don't support html imports -->
      <!--<script src="../webcomponentsjs/webcomponents-lite.min.js"></script>-->
      <!-- Import custom element. Note: see comment about relative paths to dependencies in the *.html file referenced below -->
      <link rel="import" href="../promise-polyfill/promise-polyfill-lite.html">
      <!-- <link rel="import" href="../promise-polyfill/promise.js"/> -->
      <link rel="import" href="../px-theme/px-theme-styles.html" defer>
      <!-- <link rel="import" href="../px-dark-theme/px-dark-theme-styles.html"> -->
      <style include="px-theme-styles" is="custom-style"></style>

      <link rel="import" href="../px-vis/px-vis-data-converter.html" defer />
      <link rel="import" href="../px-vis-timeseries/px-vis-timeseries.html" defer />
      <link rel="import" href="../px-vis-xy-chart/px-vis-xy-chart.html" defer />
      <link rel="import" href="../px-vis-parallel-coordinates/px-vis-parallel-coordinates.html" defer />
      <link rel="import" href="../px-vis-radar/px-vis-radar.html" defer />
      <link rel="import" href="../px-vis-polar/px-vis-polar.html" defer />
      <link rel="import" href="../px-modal/px-modal.html" defer />
      <link rel="import" href="../px-dropdown/px-dropdown.html" defer />
      <link rel="import" href="../px-popover/px-popover.html" defer />

      <link rel="import" href="../iron-ajax/iron-ajax.html" defer />

      <link rel="import" href="css/px-vis-demos-styles.html" defer>
      <style include="px-vis-demos-styles" is="custom-style"></style>

  </head>

  <body style="padding:30px; ">
    <template is="dom-bind">
      <style>
        .wapper {
          display: flex;
          flex-wrap: wrap;
        }

        .minHeight {
          margin-top:25px;
          width: 45vw;
          height: 300px;
        }
      </style>
      <div class="wapper">
        <div class="minHeight">
          <px-vis-timeseries
            id="timeseries"
            disable-navigator
            series-config='{
              "y0":{"y":"y0"},
              "y1":{"y":"y1"},
              "y2":{"y":"y2"},
              "y3":{"y":"y3"}
            }'
            default-series-config='{
              "type": "line",
              "x": "timeStamp"
            }'
            cursor-config='{
              "horizontalLine": "none"
            }'
            highlighter-config='{
              "showTooltipData": "true"
            }'
            chart-data="[[chartData]]"
            render-to-canvas
            crosshair-data="{{crosshairData}}">
          </px-vis-timeseries>
        </div>
        <div class="minHeight">
          <px-vis-xy-chart
            id="xy"
            margin='{
              "top": 5,
              "bottom":25,
              "left":50,
              "right": 10
            }'
            render-to-canvas
            cursor-config='{
              "horizontalLine": "none"
            }'
            series-config='{
              "y1":{"y":"y1"},
              "y2":{"y":"y2"},
              "y3":{"y":"y3"}
            }'
            chart-extents='{
              "x": [-45, -4],
              "y": [-10, 20]
            }'
            register-config='{
              "width": "200",
              "forceDateTimeDisplay": "true"
            }'
            default-series-config='{
              "type": "scatter",
              "x": "y0"
            }'
            chart-data="[[chartData]]"
            complete-series-config="{{completeSeriesConfigXY}}"
            time-data="timeStamp">
          </px-vis-xy-chart>
        </div>
        <div class="minHeight">
          <px-vis-parallel-coordinates
            id="para"
            chart-data="[[chartData]]"
            category-key="category"
            categories='["a","b","c","d"]'
            skip-keys='{"x":true}'
            series-key="timeStamp"
            match-ticks
            generate-axes-from-data
            axis-register-config='{
              "forceDateTimeDisplay": true
            }'>
          </px-vis-parallel-coordinates>
        </div>
        <div class="minHeight">
          <px-vis-radar
            id="radar"
            chart-data="[[chartData]]"
            category-key="category"
            categories='["a","b","c","d"]'
            skip-keys='{"x":true}'
            series-key="timeStamp"
            generate-axes-from-data
            axis-register-config='{
              "forceDateTimeDisplay": true
            }'>
          </px-vis-radar>
        </div>
        <div class="minHeight">
          <px-vis-polar
            id="polar"
            height="400"
            chart-data="[[chartData]]"
            series-config='{
              "firstSerie": {
                "y": "y1",
                "x":"y0"
              },
              "secondSerie": {
                "y": "y2",
                "x":"y0"
              }
            }'
            render-to-canvas
            register-config='{
              "forceDateTimeDisplay": true
            }'
            time-data="timeStamp">
          </px-vis-polar>
        </div>

      <px-modal
        id="modal"
        btn-modal-positive="Create"
        btn-modal-negative="Cancel">
        <div>
          <div class="flex flex--middle">
            <p>Associate annotation with series: </p>
            <px-dropdown
              id="modalDropdown"
              select-by="val"
              disable-clear>
            </px-dropdown>
          </div>
          <textarea id="modalText"></textarea>
        </div>
      </px-modal>

      <px-popover
        id="annotationPopover"
        popover-title="Annotation"
        orientation="top">
      </px-popover>


      <iron-ajax
        id="random1"
        url="../px-demo-data/demo-data/random/d4x1000.json"
        handle-as="json"
        last-response="{{chartData}}"
        auto>
      </iron-ajax>
    </template>

    <script type="text/javascript">

      // Set up our toolbar config initially
      document.addEventListener('WebComponentsReady', function() {
        setTimeout(function() {
          var timeseries = document.getElementById('timeseries'),
          xy = document.getElementById('xy'),
          para = document.getElementById('para'),
          radar = document.getElementById('radar'),
          polar = document.getElementById('polar'),
          modal = document.getElementById('modal'),
          dropdown = document.getElementById('modalDropdown'),
          text = document.getElementById('modalText'),
          popover = document.getElementById('annotationPopover'),
          currentChart,
          createAnnotation,
          mousePos,
          toolbarConfig = {
            'config': {
              'advancedZoom': true,
              'pan': true,
              'annotations': true
            }
          },
          toolbarConfigRadar = {
            'config': {
              'advancedZoom': true,
              'annotations': true,
              'axisDrag': true,
              'axisMuteSeries': true
            }
          };

          createAnnotation = function(evt) {
            currentChart = this;

            //TODO: // and radar
            var keys = Object.keys(this.completeSeriesConfig);
            mousePos = evt.detail.data.mouseCoords;

            dropdown.set('items', keys);
            dropdown.set('displayValue', keys[0]);
            modal.modalButtonClicked();
          };

          showAnnotation = function(evt) {
            popover.set('popoverBody', evt.detail.data.annotationData.data.message);
            popover.set('for', evt.detail.data.icon);
            popover.show();
          };

          hideAnnotation = function(evt) {
            popover.hide();
          };

          timeseries.addEventListener( 'px-vis-annotation-creation' , createAnnotation);
          xy.addEventListener( 'px-vis-annotation-creation' , createAnnotation);
          polar.addEventListener( 'px-vis-annotation-creation' , createAnnotation);
          radar.addEventListener( 'px-vis-annotation-creation' , createAnnotation);
          para.addEventListener( 'px-vis-annotation-creation' , createAnnotation);

          timeseries.addEventListener( 'px-vis-annotation-show' , showAnnotation);
          xy.addEventListener( 'px-vis-annotation-show' , showAnnotation);
          polar.addEventListener( 'px-vis-annotation-show' , showAnnotation);
          radar.addEventListener( 'px-vis-annotation-show' , showAnnotation);
          para.addEventListener( 'px-vis-annotation-show' , showAnnotation);

          timeseries.addEventListener( 'px-vis-annotation-hide' , hideAnnotation);
          xy.addEventListener( 'px-vis-annotation-hide' , hideAnnotation);
          polar.addEventListener( 'px-vis-annotation-hide' , hideAnnotation);
          radar.addEventListener( 'px-vis-annotation-hide' , hideAnnotation);
          para.addEventListener( 'px-vis-annotation-hide' , hideAnnotation);

          timeseries.set('toolbarConfig', toolbarConfig);
          xy.set('toolbarConfig', toolbarConfig);
          polar.set('toolbarConfig', toolbarConfig);
          radar.set('toolbarConfig', toolbarConfigRadar);
          para.set('toolbarConfig', toolbarConfigRadar);

          modal.addEventListener('btnModalPositiveClicked', function(evt) {

              //process data and assign to currentChart
              var seriesFound = dropdown.selected ? dropdown.selected : dropdown.displayValue,
                  newData = {
                    x: Number(currentChart.x.invert(mousePos[0])),
                    y: currentChart.y[currentChart.completeSeriesConfig[seriesFound].axis.id].invert(mousePos[1]),
                    data: {
                      message: text.value
                    },
                    series: seriesFound
                  };
              currentChart.push('annotationData', newData);
              text.value = "";
          });



        }, 500);
      });


      (function() {
        'use strict';

        var onload = function() {
          // For native Imports, manually fire WebComponentsReady so user code
          // can use the same code path for native and polyfill'd imports.
          if (!window.HTMLImports) {
            document.dispatchEvent(
              new CustomEvent('WebComponentsReady', {bubbles: true})
            );
          }
        };

        var webComponentsSupported = (
          'registerElement' in document && 'import' in document.createElement('link') && 'content' in document.createElement('template')
        );

        if (!webComponentsSupported) {
          var script = document.createElement('script');
          script.async = true;
          script.src = '../webcomponentsjs/webcomponents-lite.min.js';
          script.onload = onload;
          document.head.appendChild(script);
        } else {
          onload();
        }
      })();
    </script>
  </body>

</html>
